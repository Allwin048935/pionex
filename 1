import requests
import time
import hmac
import hashlib
from urllib.parse import urlencode
import json
import config  # Import config.py for API credentials

# API setup
BASE_URL = "https://api.pionex.com"
API_KEY = config.API_KEY
SECRET_KEY = config.SECRET_KEY

# Function to generate HMAC SHA256 signature
def generate_signature(method, path, params, body=None):
    # Step 1: Get current timestamp in milliseconds
    timestamp = str(int(time.time() * 1000))
    
    # Step 2 & 3: Sort query parameters and concatenate with &
    query_params = params.copy()
    query_params['timestamp'] = timestamp
    sorted_params = urlencode(sorted(query_params.items()))
    
    # Step 4: Concatenate PATH with query string
    path_url = f"{path}?{sorted_params}"
    
    # Step 5: Concatenate METHOD and PATH_URL
    string_to_sign = f"{method}{path_url}"
    
    # Step 6: Append body if POST or DELETE (for POST /trade/order)
    if body:
        string_to_sign += json.dumps(body, separators=(',', ':'))
    
    # Step 7: Generate HMAC SHA256 signature with secret key
    signature = hmac.new(
        SECRET_KEY.encode('utf-8'),
        string_to_sign.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    
    return signature, timestamp

# Function to make authenticated API requests
def api_request(method, endpoint, params=None, body=None):
    if params is None:
        params = {}
    
    # Generate signature and timestamp
    signature, timestamp = generate_signature(method, endpoint, params, body)
    params['timestamp'] = timestamp
    
    url = f"{BASE_URL}{endpoint}"
    headers = {
        "PIONEX-KEY": API_KEY,
        "PIONEX-SIGNATURE": signature,
        "Content-Type": "application/json"
    }
    
    try:
        if method == "GET":
            response = requests.get(url, headers=headers, params=params)
        elif method == "POST":
            response = requests.post(url, headers=headers, params=params, data=json.dumps(body))
        else:
            raise ValueError("Unsupported method")
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"API request failed: {e}")
        return None

# Function to get current price
def get_price(symbol="BTC_USDT"):
    endpoint = "/api/v1/market/tickers"
    params = {"symbols": symbol}
    data = api_request("GET", endpoint, params)
    if data and 'data' in data and 'tickers' in data['data']:
        ticker = data['data']['tickers'][0]
        return float(ticker['last'])
    else:
        print("Failed to fetch price")
        return None

# Function to place an order
def place_order(symbol, side, quantity, price):
    endpoint = "/api/v1/trade/order"
    params = {}  # Query params (timestamp added by api_request)
    body = {
        "symbol": symbol,
        "side": side.upper(),  # "BUY" or "SELL"
        "type": "LIMIT",
        "size": str(quantity),  # Quantity as string
        "price": str(price),   # Price as string
        "IOC": False           # Immediate or Cancel (optional)
    }
    response = api_request("POST", endpoint, params, body)
    if response and 'data' in response and response['result']:
        return response['data']
    else:
        print(f"Order placement failed: {response}")
        return None

# Trading bot logic
def trading_bot():
    symbol = "BTC_USDT"
    buy_threshold = 26000  # Buy if price < $26,000
    sell_threshold = 27000  # Sell if price > $27,000
    quantity = 0.001       # Amount of BTC to trade
    holding = False        # Track if we own BTC

    print("Starting Pionex trading bot...")
    while True:
        try:
            price = get_price(symbol)
            if price is None:
                time.sleep(60)
                continue

            print(f"Current {symbol} price: ${price}")

            if not holding and price < buy_threshold:
                print(f"Price below ${buy_threshold}! Buying {quantity} BTC at ${price}")
                result = place_order(symbol, "BUY", quantity, price)
                if result:
                    print(f"Buy order placed: Order ID {result['orderId']}")
                    holding = True
            elif holding and price > sell_threshold:
                print(f"Price above ${sell_threshold}! Selling {quantity} BTC at ${price}")
                result = place_order(symbol, "SELL", quantity, price)
                if result:
                    print(f"Sell order placed: Order ID {result['orderId']}")
                    holding = False
            else:
                print("No action taken.")

            time.sleep(60)  # Check every minute
        except Exception as e:
            print(f"Error in bot loop: {e}")
            time.sleep(60)

# Run the bot
if __name__ == "__main__":
    trading_bot()
